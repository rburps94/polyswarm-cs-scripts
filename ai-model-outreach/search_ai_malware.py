import requests
import time
import json

API_KEY = "api_key"
BASE_URL = "https://api.polyswarm.network/v3"
COMMUNITY = "default"

domains_to_query = [
    "openai.com",
    "api.openai.com",
    "anthropic.com",
    "api.anthropic.com",
    "claude.ai",
    "googleapis.com",
    "generativelanguage.googleapis.com",
    "vertex.googleapis.com",
    "aiplatform.googleapis.com",
    "googleusercontent.com",
    "copilot.microsoft.com",
    "api.copilot.microsoft.com",
    "bingcopilot.microsoft.com",
    "meta.com",
    "meta.ai",
    "llama.meta.com",
    "llama-api.fe.meta.com",
    "bedrock.aws",
    "runtime.bedrock.amazonaws.com",
    "bedrock-runtime.amazonaws.com",
    "mistral.ai",
    "api.mistral.ai",
    "cohere.ai",
    "api.cohere.ai",
    "huggingface.co",
    "hf.space",
    "perplexity.ai",
    "api.perplexity.ai"
]

def search_associated_hashes(domain):
    url = f"{BASE_URL}/ioc/search"
    params = {"domain": domain, "community": COMMUNITY, "start_date": "365d", "end_date": "0d"}


    headers = {"Authorization": API_KEY}

    resp = requests.get(url, headers=headers, params=params)

    # Valid case: 204 = no data
    if resp.status_code == 204:
        return {"results": []}

    # Any other non-200 error
    if resp.status_code != 200:
        print("\n--- API ERROR ---")
        print(f"Domain: {domain}")
        print(f"HTTP {resp.status_code}")
        print(resp.text)
        print("--- END ERROR ---\n")
        resp.raise_for_status()

    return resp.json()

def main():
    results = {}

    for domain in domains_to_query:
        print(f"Querying domain: {domain}")
        try:
            data = search_associated_hashes(domain)
            results[domain] = data
        except Exception as e:
            print(f"Error querying {domain}: {e}")
            results[domain] = {"error": str(e)}

        time.sleep(1)

    with open("llm_domain_hash_search_results.json", "w") as f:
        json.dump(results, f, indent=2)

    print("\nDone. Results saved to llm_domain_hash_search_results.json\n")

if __name__ == "__main__":
    main()
